<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veridian AI Sales - Intelligent Sales Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .modal-backdrop { transition: opacity 300ms ease-in-out; }
        .modal .modal-content {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            transition: opacity 300ms ease-out, transform 300ms ease-out;
        }
        .modal.modal-enter-active .modal-content {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .modal.modal-leave-active .modal-content {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        .modal {
            opacity: 0;
            transition: opacity 300ms ease-in-out;
        }
        .modal.modal-enter-active {
            opacity: 1;
        }
        .modal.modal-leave-active {
            opacity: 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px; height: 24px;
            border-radius: 50%;
            border-left-color: #fff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stage-select, .type-select, .client-type-select, .activity-type-select, .partner-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div id="app" class="flex min-h-screen">
        <aside class="w-16 md:w-20 lg:w-64 bg-slate-800 text-white flex flex-col transition-all duration-300">
            <div class="h-20 flex items-center justify-center lg:justify-start lg:pl-6 shrink-0">
                <svg class="h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                <span class="text-2xl font-bold ml-3 hidden lg:block">Veridian AI</span>
            </div>
            <nav id="mainNav" class="flex-grow px-2 lg:px-4 py-4">
                </nav>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8">
            <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div>
                    <h1 id="greeting" class="text-3xl font-bold text-slate-800">Good morning</h1>
                    <p class="text-slate-500 mt-1">Here's your intelligent sales briefing for today.</p>
                </div>
                <div class="flex items-center">
                    <button id="addClientHeaderBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center mr-4">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add New Client
                    </button>
                    <img id="userAvatar" src="https://placehold.co/40x40/6366f1/ffffff?text=U" alt="User Avatar" class="w-10 h-10 rounded-full cursor-pointer" title="Click to change name / logout">
                </div>
            </header>

            <div id="contentArea">
                </div>
        </main>
    </div>

    <div id="modalContainer"></div>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State & Configuration ---
        const state = {
            currentUser: null,
            opportunities: [],
            leads: [],
            activityLog: [],
            forecasts: {},
            currentView: 'dashboard',
            // API KEY REMOVED FROM HERE
            pitneyProducts: [
                "PitneyShip Pro", "PitneyShip Enterprise", "PitneyAnalytics",
                "PitneyTrack", "ParcelPoint Smart Lockers", "Mailstream OnDemand",
                "Relay Unify"
            ],
            partnerData: {
                "KARL": ["Coastal Business Solutions", "Dakota Mailing Inc.", "DSI (Document Strategies Inc)", "First Choice", "Universal Business Solutions"],
                "RONDIELLE": ["Arkansas Mailing Services Inc", "CRI Digital", "Independent Mailing Systems", "Laser Resources LLC", "Northeast Mailing Systems LLC", "Pinnacle", "Technocom Business Systems / Visual Edge"],
                "SASA": ["Amasti", "Greentrail", "Kelley Imaging Systems, Inc", "STR Business Solutions"],
                "TY": ["Hawaii", "ISA - New Partners", "NVR Color Mail Systems", "Texas Office Systems, Inc", "Unison Business Solutions", "Waltz Mailing", "Preferred Business Systems"],
                "ED": ["Troy Group"],
                "NASR": ["Advantage Business Systems"]
            },
            defaultAnalysis: {
                opportunityScore: 0, predictedWinRate: 0, recommendedProduct: "N/A", companyIntel: "N/A",
                strategicSummary: "N/A", nextBestAction: "N/A", potentialRisks: [],
                personalizedValueProposition: "N/A", autoGeneratedEmail: { subject: "", body: "" },
                totalMonthlyShippingSpend: "", currentEquipment: "", clientType: "New", currentProduct: "", competitiveProduct: ""
            }
        };

        // --- DOM Element References ---
        const dom = {
            mainNav: document.getElementById('mainNav'),
            greeting: document.getElementById('greeting'),
            userAvatar: document.getElementById('userAvatar'),
            contentArea: document.getElementById('contentArea'),
            modalContainer: document.getElementById('modalContainer'),
            addClientHeaderBtn: document.getElementById('addClientHeaderBtn')
        };

        // --- Core App Logic ---
        const init = () => {
            checkUser();
            attachStaticEventListeners();
        };

        const checkUser = () => {
            const savedUser = localStorage.getItem('veridian-user');
            if (savedUser) {
                setupUser(savedUser);
            } else {
                renderLogin();
            }
        };

        const setupUser = (name) => {
            const trimmedName = name.trim();
            const capitalizedName = trimmedName.charAt(0).toUpperCase() + trimmedName.slice(1).toLowerCase();
            state.currentUser = capitalizedName.toUpperCase();
            localStorage.setItem('veridian-user', state.currentUser);
            dom.greeting.textContent = `Good morning, ${capitalizedName}`;
            const initial = state.currentUser.charAt(0).toUpperCase();
            dom.userAvatar.src = `https://placehold.co/40x40/6366f1/ffffff?text=${initial}`;
            dom.userAvatar.alt = `Avatar for ${state.currentUser}`;

            loadState();
            renderNav();
            renderView('dashboard');
            dom.mainNav.style.display = 'block';
        };

        const renderLogin = () => {
            dom.mainNav.style.display = 'none';
            const loginModalHTML = `
                <div id="userModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8">
                        <h3 class="text-2xl font-bold text-slate-800 text-center">Welcome to Veridian AI Sales</h3>
                        <p class="text-slate-500 text-center mt-2">Please enter your name to personalize your dashboard.</p>
                        <form id="userForm" class="mt-6">
                            <label for="username" class="block text-sm font-medium text-slate-600 mb-1">Your Name</label>
                            <input type="text" id="username" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none" placeholder="e.g., Karl">
                            <button type="submit" class="w-full mt-4 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg transition-colors">
                                Save and Continue
                            </button>
                        </form>
                    </div>
                </div>`;
            openModal(loginModalHTML, () => {
                document.getElementById('userForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const usernameInput = document.getElementById('username');
                    if (usernameInput.value.trim()) {
                        setupUser(usernameInput.value.trim());
                        closeModal();
                    }
                });
            });
        };

        const renderNav = () => {
            const navItems = [
                { id: 'dashboard', icon: '<svg class="h-6 w-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>', text: 'Dashboard' },
                { id: 'addClient', icon: '<svg class="h-6 w-6 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 10a8 8 0 0 0-8-8v8h8z"/><path d="M22 10V6ZM14 10h8Z"/></svg>', text: 'Add Client' },
                { id: 'leads', icon: '<svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>', text: 'Leads' },
                { id: 'activities', icon: '<svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h7.5A2.25 2.25 0 0 1 13.5 5.25v2.25M4.5 17.25h9.75M18 5.25v1.5M18 11.25v.75M18 7.5v-.75m0 5.25v.75m0 3v-.75m0 3H12a2.25 2.25 0 0 0-2.25 2.25v.75m6-3h3.75m-3.75 0H18m-9.75 0h9.75"></path></svg>', text: 'Activities' },
                { id: 'reporting', icon: '<svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m-4.5 7.5h15A2.25 2.25 0 0 0 21 21.75V3m-6.75 18L7.5 14.25m0 0L3.75 21.75M15 10.5V31.5"></path></svg>', text: 'Reporting' },
                { id: 'forecast', icon: '<svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>', text: 'Forecast' }
            ];

            dom.mainNav.innerHTML = navItems.map(item => {
                if (item.id === 'forecast' && (!state.currentUser || !state.partnerData[state.currentUser])) {
                    return '';
                }
                return `<a href="#" data-nav-id="${item.id}" class="nav-link flex items-center p-3 my-1 rounded-lg ${item.id === state.currentView ? 'bg-sky-500/20 text-sky-300' : 'hover:bg-slate-700'} transition-colors">
                    ${item.icon}
                    <span class="ml-4 font-semibold hidden lg:block">${item.text}</span>
                </a>`;
            }).join('');
        };

        const renderView = (viewId) => {
            state.currentView = viewId;
            renderNav();
            dom.contentArea.innerHTML = '';

            if (viewId === 'dashboard') {
                dom.contentArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">Your Veridian AI Intelligence Briefing</h2>
                        <div id="nbaContent" class="flex flex-col md:flex-row items-start md:items-center"></div>
                    </div>

                    <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-semibold text-slate-800 mb-4">Pipeline Summary</h2>
                        <div id="pipelineSummary" class="flex flex-wrap gap-4 justify-between text-center"></div>
                    </div>

                    <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-slate-800">Pipeline Opportunities</h2>
                            <div class="flex items-center space-x-2">
                                <button id="emailVpBtn" class="text-sm bg-green-100 hover:bg-green-200 text-green-700 font-semibold py-2 px-3 rounded-lg transition-colors flex items-center">
                                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75"/></svg>
                                    Email My VP
                                </button>
                                <button id="exportCsvBtn" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors flex items-center">
                                    <svg class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    Export to CSV
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b border-slate-200 text-sm text-slate-500">
                                        <th class="py-3 pr-4 font-medium">Company</th><th class="py-3 px-4 font-medium">Score</th><th class="py-3 px-4 font-medium">Win Rate</th><th class="py-3 px-4 font-medium">Stage</th><th class="py-3 px-4 font-medium">Type</th><th class="py-3 px-4 font-medium">Rec. Product</th><th class="py-3 px-4 font-medium">Value</th><th class="py-3 pl-4 font-medium text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="opportunitiesTableBody"></tbody>
                            </table>
                            <div id="noOpportunities" class="text-center py-10 text-slate-500">
                                <p>No opportunities yet. Click "Add New Client" to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>`;
                renderDashboardContent();
            } else if (viewId === 'leads') {
                renderLeadsView();
            } else if (viewId === 'activities') {
                renderActivitiesView();
            } else if (viewId === 'reporting') {
                renderReportingView();
            } else if (viewId === 'forecast') {
                renderForecastView();
            }
        };

        const renderDashboardContent = () => {
            renderPipelineSummary();
            renderOpportunities();
            renderNextBestAction();
            document.getElementById('emailVpBtn').addEventListener('click', () => {
                const totalValue = state.opportunities.reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0), 0);
                const subject = `Pipeline Summary for ${state.currentUser} - ${new Date().toLocaleDateString()}`;
                const body = `Hi VP,\n\nHere is my current pipeline summary:\n\n- Total Pipeline Value: $${totalValue.toLocaleString()}\n- Total Opportunities: ${state.opportunities.length}\n\nBest regards,\n${state.currentUser}`;
                window.location.href = `mailto:vp@example.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            });
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        };

        const attachStaticEventListeners = () => {
            dom.addClientHeaderBtn.addEventListener('click', () => openClientModal());
            dom.userAvatar.addEventListener('click', () => {
                const logoutModalHTML = `
                <div id="logoutModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8">
                        <h3 class="text-xl font-bold text-slate-800 text-center">Log Out</h3>
                        <p class="text-slate-500 text-center mt-2">Are you sure you want to log out? This will clear all your saved data.</p>
                        <div class="flex justify-center mt-6 space-x-4">
                               <button id="cancelLogout" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                               <button id="confirmLogout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Log Out</button>
                        </div>
                    </div>
                </div>`;
                openModal(logoutModalHTML, () => {
                    document.getElementById('confirmLogout').addEventListener('click', () => {
                        localStorage.removeItem('veridian-user');
                        localStorage.removeItem(`opportunities-${state.currentUser}`);
                        localStorage.removeItem(`leads-${state.currentUser}`);
                        localStorage.removeItem(`activityLog-${state.currentUser}`);
                        window.location.reload();
                    });
                     document.getElementById('cancelLogout').addEventListener('click', closeModal);
                });
            });

            dom.mainNav.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (!navLink) return;
                e.preventDefault();
                const navId = navLink.dataset.navId;
                closeModal();
                switch (navId) {
                    case 'dashboard': renderView('dashboard'); break;
                    case 'addClient': openClientModal(); break;
                    case 'leads': renderView('leads'); break;
                    case 'activities': renderView('activities'); break;
                    case 'reporting': renderView('reporting'); break;
                    case 'forecast': renderView('forecast'); break;
                }
            });
        };

        const loadState = () => {
            if (!state.currentUser) return;
            state.opportunities = JSON.parse(localStorage.getItem(`opportunities-${state.currentUser}`) || '[]');
            state.leads = JSON.parse(localStorage.getItem(`leads-${state.currentUser}`) || '[]');
            const savedActivityLog = localStorage.getItem(`activityLog-${state.currentUser}`);
            if (savedActivityLog) {
                state.activityLog = JSON.parse(savedActivityLog);
            } else {
                state.activityLog = [
                    { id: generateUniqueId(), type: 'Call', description: 'Discussed new requirements with potential client Inc.', date: '2023-10-27', time: '10:00 AM' },
                    { id: generateUniqueId(), type: 'Email', description: 'Sent follow-up proposal to client.', date: '2023-10-26', time: '02:30 PM' },
                ];
            }
        };

        const saveState = () => {
            if (state.currentUser) {
                localStorage.setItem(`opportunities-${state.currentUser}`, JSON.stringify(state.opportunities));
                localStorage.setItem(`leads-${state.currentUser}`, JSON.stringify(state.leads));
                localStorage.setItem(`activityLog-${state.currentUser}`, JSON.stringify(state.activityLog));
            }
        };

        const generateUniqueId = () => Math.random().toString(36).substring(2, 9);

        const openModal = (htmlContent, onOpenCallback = null) => {
            dom.modalContainer.innerHTML = htmlContent;
            const modal = dom.modalContainer.querySelector('.modal');
            if (!modal) return;

            setTimeout(() => modal.classList.add('modal-enter-active'), 10);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            document.addEventListener('keydown', closeModalOnEscape);
            if (onOpenCallback) onOpenCallback();
        };

        const closeModal = () => {
            const modal = dom.modalContainer.querySelector('.modal');
            if (modal) {
                modal.classList.remove('modal-enter-active');
                modal.classList.add('modal-leave-active');
                modal.addEventListener('transitionend', () => {
                    dom.modalContainer.innerHTML = '';
                }, { once: true });
                document.removeEventListener('keydown', closeModalOnEscape);
            }
        };

        const closeModalOnEscape = (e) => {
            if (e.key === 'Escape') closeModal();
        };
        window.closeModal = closeModal;

        const renderPipelineSummary = () => {
            const summaryDiv = document.getElementById('pipelineSummary');
            if(!summaryDiv) return;

            const totalValue = state.opportunities.reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0), 0);
            const organicValue = state.opportunities.filter(opp => opp.clientType === 'Organic').reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0), 0);
            const newValue = state.opportunities.filter(opp => opp.clientType === 'New').reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0), 0);
            const competitiveValue = state.opportunities.filter(opp => opp.clientType === 'Competitive').reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0), 0);

            summaryDiv.innerHTML = `
                <div class="bg-sky-50 p-4 rounded-xl shadow-md flex-1 min-w-[200px]">
                    <p class="text-sm font-medium text-slate-500">Total Pipeline</p>
                    <p class="text-2xl font-bold text-sky-700 mt-1">$${totalValue.toLocaleString()}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-xl shadow-md flex-1 min-w-[200px]">
                    <p class="text-sm font-medium text-slate-500">Organic Client Value</p>
                    <p class="text-2xl font-bold text-green-700 mt-1">$${organicValue.toLocaleString()}</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl shadow-md flex-1 min-w-[200px]">
                    <p class="text-sm font-medium text-slate-500">New Client Value</p>
                    <p class="text-2xl font-bold text-purple-700 mt-1">$${newValue.toLocaleString()}</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl shadow-md flex-1 min-w-[200px]">
                    <p class="text-sm font-medium text-slate-500">Competitive Client Value</p>
                    <p class="text-2xl font-bold text-orange-700 mt-1">$${competitiveValue.toLocaleString()}</p>
                </div>
            `;
        };

        const renderOpportunities = () => {
            const container = document.getElementById('opportunitiesTableBody');
            const noOpportunitiesDiv = document.getElementById('noOpportunities');
            if (!container || !noOpportunitiesDiv) return;

            noOpportunitiesDiv.style.display = state.opportunities.length === 0 ? 'block' : 'none';
            if (state.opportunities.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = state.opportunities.map(opp => `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                    <td class="py-3 pr-4 font-semibold text-slate-800">${opp.companyName}</td>
                    <td class="py-3 px-4">${opp.opportunityScore}%</td>
                    <td class="py-3 px-4">${opp.predictedWinRate}%</td>
                    <td class="py-3 px-4">${opp.stage}</td>
                    <td class="py-3 px-4">${opp.type}</td>
                    <td class="py-3 px-4">${opp.recommendedProduct}</td>
                    <td class="py-3 px-4">$${(parseInt(opp.estimatedValue) || 0).toLocaleString()}</td>
                    <td class="py-3 pl-4 text-center">
                        <button data-id="${opp.id}" class="edit-btn text-sky-500 hover:text-sky-700 font-medium text-sm mr-2">Edit</button>
                        <button data-id="${opp.id}" class="delete-btn text-red-500 hover:text-red-700 font-medium text-sm">Delete</button>
                    </td>
                </tr>
            `).join('');

            container.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const opportunity = state.opportunities.find(opp => opp.id === e.target.dataset.id);
                    if (opportunity) openClientModal(opportunity);
                });
            });
            container.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const companyName = state.opportunities.find(o => o.id === id)?.companyName || 'this opportunity';
                    const deleteModalHTML = `
                    <div id="deleteModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8">
                            <h3 class="text-xl font-bold text-slate-800 text-center">Delete Opportunity</h3>
                            <p class="text-slate-500 text-center mt-2">Are you sure you want to delete "${companyName}"?</p>
                            <div class="flex justify-center mt-6 space-x-4">
                                <button id="cancelDelete" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                                <button id="confirmDelete" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Delete</button>
                            </div>
                        </div>
                    </div>`;
                    openModal(deleteModalHTML, () => {
                         document.getElementById('confirmDelete').addEventListener('click', () => {
                            state.opportunities = state.opportunities.filter(opp => opp.id !== id);
                            saveState();
                            renderOpportunities();
                            renderNextBestAction();
                            renderPipelineSummary();
                            closeModal();
                         });
                         document.getElementById('cancelDelete').addEventListener('click', closeModal);
                    });
                });
            });
        };

        const renderNextBestAction = () => {
            const container = document.getElementById('nbaContent');
            if (!container) return;

            if (state.opportunities.length > 0) {
                const firstOpp = state.opportunities[0];
                container.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-slate-600 mb-2">Based on your pipeline intelligence:</p>
                        <p class="text-xl font-bold text-sky-600 mb-2">Next Best Action: <span class="font-normal">${firstOpp.nextBestAction || 'No specific action generated yet.'}</span></p>
                        <p class="text-slate-600 text-sm">Opportunity: <span class="font-semibold">${firstOpp.companyName} (${firstOpp.stage})</span></p>
                        <p class="text-slate-600 text-sm">Predicted Win: <span class="font-semibold text-green-600">${firstOpp.predictedWinRate}%</span></p>
                    </div>
                `;
            } else {
                container.innerHTML = `<p class="text-slate-600 text-center w-full">No active opportunities. Add a new client to get your first intelligence briefing!</p>`;
            }
        };

        const renderLeadsView = () => {
            dom.contentArea.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Live Sales Leads</h2>
                    <div class="mb-4 p-4 border border-blue-200 bg-blue-50 rounded-lg">
                        <label for="leadGenerationPrompt" class="block text-sm font-medium text-slate-700 mb-2">
                            Describe the leads you want to find (e.g., "tech companies in Austin"):
                        </label>
                        <textarea id="leadGenerationPrompt" rows="2" class="mt-1 block w-full border border-blue-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 3 software companies in New York"></textarea>
                        <p id="leadGenerationStatus" class="text-sm text-slate-500 mt-2"></p>
                        <button id="generateLeadsBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center mt-3">
                            <span id="leadsSpinner" class="spinner mr-2 hidden border-sky-300 border-l-white"></span>
                            Find Live Leads
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-slate-200 text-sm text-slate-500">
                                    <th class="py-3 pr-4 font-medium">Company</th>
                                    <th class="py-3 px-4 font-medium">Status</th>
                                    <th class="py-3 px-4 font-medium">Source</th>
                                    <th class="py-3 px-4 font-medium">Contacts</th>
                                    <th class="py-3 px-4 font-medium">Date Found</th>
                                    <th class="py-3 pl-4 font-medium text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody"></tbody>
                        </table>
                        <div id="noLeads" class="text-center py-10 text-slate-500 hidden">
                            <p>No leads yet. Use the AI to find live leads from the web!</p>
                        </div>
                    </div>
                </div>
            `;
            renderLeadsTable();

            document.getElementById('generateLeadsBtn').addEventListener('click', async () => {
                const prompt = document.getElementById('leadGenerationPrompt').value.trim();
                if (!prompt) {
                    openModal(`<div class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"><div class="modal-content bg-white rounded-lg p-6 w-full max-w-sm"><p>Please enter a prompt for lead generation.</p><button onclick="closeModal()" class="mt-4 bg-sky-500 text-white py-2 px-4 rounded">OK</button></div></div>`);
                    return;
                }
                const btn = document.getElementById('generateLeadsBtn');
                const spinner = document.getElementById('leadsSpinner');
                const statusText = document.getElementById('leadGenerationStatus');

                btn.disabled = true;
                spinner.classList.remove('hidden');
                statusText.textContent = 'Performing live web search to find companies...';

                try {
                    await generateLeadsWithAI(prompt);
                    statusText.textContent = 'Live leads found successfully!';
                } catch (error) {
                    console.error("Error generating leads:", error);
                    statusText.textContent = `Error finding leads: ${error.message}.` ;
                } finally {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                }
            });
        };

        // MODIFIED: Calls the secure backend function
        const generateLeadsWithAI = async (prompt) => {
            const searchPrompt = `As a sales intelligence tool, perform a web search to find real companies based on this request: "${prompt}". Provide the results as a JSON array. Each object must have 'company' (the real company name), 'domain' (their actual website domain), 'status': 'New', 'source': 'Web Search', and 'date'. Output ONLY the JSON array.`;

            const response = await fetch('/.netlify/functions/generateWithGemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: searchPrompt }),
            });

            if (!response.ok) throw new Error(`API call failed: ${response.statusText}`);
            const data = await response.json();
            const textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!textContent) throw new Error("No content received from AI.");

            const generatedLeads = JSON.parse(textContent.trim().replace(/^```json\s*|```$/g, ''));

            const newLeads = (Array.isArray(generatedLeads) ? generatedLeads : [generatedLeads]).map(lead => ({
                id: generateUniqueId(),
                company: lead.company || 'Unknown Company',
                domain: lead.domain || '',
                status: lead.status || 'New',
                source: 'AI Web Search',
                date: lead.date || new Date().toISOString().split('T')[0],
                contacts: []
            }));

            state.leads = [...state.leads, ...newLeads];
            saveState();
            renderLeadsTable();
        };

        // MODIFIED: Calls the secure backend function
        const generateContactsWithAI = async (companyName, domain) => {
            const searchPrompt = `As a sales intelligence tool, perform a targeted web search for the leadership team at "${companyName}" (website: ${domain}). Find 2-3 real, key decision-makers (like CEO, VP of Sales, CTO, Head of Marketing). Provide the results as a JSON array of objects, each with "name" and "title". Output ONLY the JSON array.`;

            const response = await fetch('/.netlify/functions/generateWithGemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: searchPrompt }),
            });

            if (!response.ok) throw new Error(`API call failed: ${response.statusText}`);
            const data = await response.json();
            const textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!textContent) throw new Error("No content received from AI for contacts.");

            return JSON.parse(textContent.trim().replace(/^```json\s*|```$/g, ''));
        };

        const renderLeadsTable = () => {
            const container = document.getElementById('leadsTableBody');
            const noLeadsDiv = document.getElementById('noLeads');

            noLeadsDiv.classList.toggle('hidden', state.leads.length > 0);
            if(state.leads.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = state.leads.map(lead => `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                    <td class="py-3 pr-4 font-semibold text-slate-800">${lead.company}</td>
                    <td class="py-3 px-4">${lead.status}</td>
                    <td class="py-3 px-4">${lead.source}</td>
                    <td class="py-3 px-4 contacts-cell" data-lead-id="${lead.id}">
                        ${lead.contacts && lead.contacts.length > 0
                            ? lead.contacts.map(c => `<div class="text-sm">${c.name} <span class="text-slate-500">(${c.title})</span></div>`).join('')
                            : `<button data-id="${lead.id}" class="get-contacts-btn text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-1 px-3 rounded-md transition-colors flex items-center">
                                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.5 21.75c-2.636 0-5.058-.95-7.022-2.515z" /></svg>
                                Get Contacts
                               </button>`
                        }
                    </td>
                    <td class="py-3 px-4">${lead.date}</td>
                    <td class="py-3 pl-4 text-center">
                        <button data-id="${lead.id}" class="delete-lead-btn text-red-500 hover:text-red-700 font-medium text-sm">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            container.querySelectorAll('.get-contacts-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.closest('button').dataset.id;
                    const lead = state.leads.find(l => l.id === id);
                    const cell = e.target.closest('.contacts-cell');

                    if (lead && cell) {
                        cell.innerHTML = `<div class="flex items-center text-sm text-slate-500"><div class="spinner !w-4 !h-4 !border-2 mr-2 border-slate-300 border-l-slate-500"></div>Searching...</div>`;
                        try {
                            const contacts = await generateContactsWithAI(lead.company, lead.domain);
                            lead.contacts = contacts;
                            saveState();
                            renderLeadsTable();
                        } catch (error) {
                            console.error("Failed to get contacts:", error);
                            cell.innerHTML = `<span class="text-xs text-red-500">Error fetching.</span>`;
                        }
                    }
                });
            });

            container.querySelectorAll('.delete-lead-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const deleteLeadModalHTML = `
                    <div id="deleteLeadModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8">
                            <h3 class="text-xl font-bold text-slate-800 text-center">Delete Lead</h3>
                            <p class="text-slate-500 text-center mt-2">Are you sure you want to delete this lead?</p>
                            <div class="flex justify-center mt-6 space-x-4">
                                <button id="cancelDeleteLead" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                                <button id="confirmDeleteLead" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Delete</button>
                            </div>
                        </div>
                    </div>`;
                    openModal(deleteLeadModalHTML, () => {
                        document.getElementById('confirmDeleteLead').addEventListener('click', () => {
                            state.leads = state.leads.filter(l => l.id !== id);
                            saveState();
                            renderLeadsTable();
                            closeModal();
                        });
                        document.getElementById('cancelDeleteLead').addEventListener('click', closeModal);
                    });
                });
            });
        };

        const renderActivitiesView = () => {
            dom.contentArea.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800">Your Activity Log</h2>
                    <button id="addActivityBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Log New Activity
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-slate-200 text-sm text-slate-500">
                                <th class="py-3 pr-4 font-medium">Date & Time</th>
                                <th class="py-3 px-4 font-medium">Type</th>
                                <th class="py-3 px-4 font-medium">Description</th>
                                <th class="py-3 pl-4 font-medium text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activitiesTableBody"></tbody>
                    </table>
                    <div id="noActivities" class="text-center py-10 text-slate-500 hidden">
                        <p>No activities logged yet. Log your first activity!</p>
                    </div>
                </div>
            </div>
            `;
            renderActivitiesTable();
            document.getElementById('addActivityBtn').addEventListener('click', openLogActivityModal);
        };

        const renderActivitiesTable = () => {
            const container = document.getElementById('activitiesTableBody');
            const noActivitiesDiv = document.getElementById('noActivities');
            noActivitiesDiv.classList.toggle('hidden', state.activityLog.length > 0);
            container.innerHTML = state.activityLog.map(activity => `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                    <td class="py-3 pr-4 font-semibold text-slate-800">${activity.date} ${activity.time}</td>
                    <td class="py-3 px-4">${activity.type}</td>
                    <td class="py-3 px-4">${activity.description}</td>
                    <td class="py-3 pl-4 text-center">
                        <button data-id="${activity.id}" class="delete-activity-btn text-red-500 hover:text-red-700 font-medium text-sm">Delete</button>
                    </td>
                </tr>
            `).join('');

            container.querySelectorAll('.delete-activity-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const deleteActivityModalHTML = `
                    <div id="deleteActivityModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8">
                            <h3 class="text-xl font-bold text-slate-800 text-center">Delete Activity</h3>
                            <p class="text-slate-500 text-center mt-2">Are you sure you want to delete this activity?</p>
                            <div class="flex justify-center mt-6 space-x-4">
                                <button id="cancelDeleteActivity" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
                                <button id="confirmDeleteActivity" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Delete</button>
                            </div>
                        </div>
                    </div>`;
                    openModal(deleteActivityModalHTML, () => {
                        document.getElementById('confirmDeleteActivity').addEventListener('click', () => {
                            state.activityLog = state.activityLog.filter(a => a.id !== id);
                            saveState();
                            renderActivitiesTable();
                            closeModal();
                        });
                        document.getElementById('cancelDeleteActivity').addEventListener('click', closeModal);
                    });
                });
            });
        };

        const openLogActivityModal = () => {
            const activityTypes = ['Call', 'Email', 'Meeting', 'Demo', 'Proposal Sent', 'Follow-up'];
            const modalHTML = `
            <div class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Log New Activity</h2>
                    <button class="absolute top-4 right-4 text-slate-400 hover:text-slate-600" onclick="closeModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    <form id="logActivityForm" class="space-y-4">
                        <div>
                            <label for="activityType" class="block text-sm font-medium text-slate-700">Activity Type</label>
                            <select id="activityType" class="activity-type-select mt-1 block w-full pl-3 pr-10 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 bg-white" required>
                                ${activityTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="activityDescription" class="block text-sm font-medium text-slate-700">Description</label>
                            <textarea id="activityDescription" rows="3" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500" required></textarea>
                        </div>
                        <div>
                            <label for="activityDate" class="block text-sm font-medium text-slate-700">Date</label>
                            <input type="date" id="activityDate" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div>
                            <label for="activityTime" class="block text-sm font-medium text-slate-700">Time</label>
                            <input type="time" id="activityTime" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500" value="${new Date().toTimeString().slice(0, 5)}" required>
                        </div>
                        <div class="flex justify-end pt-6 border-t border-slate-200 mt-6">
                            <button type="button" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg mr-2" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg">Log Activity</button>
                        </div>
                    </form>
                </div>
            </div>`;
            openModal(modalHTML, () => {
                document.getElementById('logActivityForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newActivity = {
                        id: generateUniqueId(),
                        type: document.getElementById('activityType').value,
                        description: document.getElementById('activityDescription').value,
                        date: document.getElementById('activityDate').value,
                        time: document.getElementById('activityTime').value
                    };
                    state.activityLog.unshift(newActivity);
                    saveState();
                    renderActivitiesTable();
                    closeModal();
                });
            });
        };

        const renderReportingView = () => {
            dom.contentArea.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Sales Reporting & Analytics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">Opportunities by Stage</h3>
                        <div class="w-full h-fit flex justify-center items-center"><canvas id="opportunitiesStageChart"></canvas></div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">Opportunities by Client Type</h3>
                        <div class="w-full h-fit flex justify-center items-center"><canvas id="opportunitiesClientTypeChart"></canvas></div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <p class="text-sm font-medium text-slate-500">Weighted Pipeline Value</p>
                            <p class="text-2xl font-bold text-purple-700 mt-1" id="weightedPipelineValue"></p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <p class="text-sm font-medium text-slate-500">Average Opportunity Value</p>
                            <p class="text-2xl font-bold text-yellow-700 mt-1" id="avgOpportunityValue"></p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <p class="text-sm font-medium text-slate-500">Total Activities</p>
                            <p class="text-2xl font-bold text-blue-700 mt-1">${state.activityLog.length}</p>
                        </div>
                    </div>
                </div>
            </div>`;

            const stageCounts = state.opportunities.reduce((acc, opp) => ({ ...acc, [opp.stage]: (acc[opp.stage] || 0) + 1 }), {});
            const clientTypeCounts = state.opportunities.reduce((acc, opp) => ({ ...acc, [opp.clientType]: (acc[opp.clientType] || 0) + 1 }), {});
            const chartColors = ['rgba(54, 162, 235, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(255, 159, 64, 0.6)'];

            new Chart(document.getElementById('opportunitiesStageChart'), {
                type: 'bar',
                data: { labels: Object.keys(stageCounts), datasets: [{ data: Object.values(stageCounts), backgroundColor: chartColors }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });

            new Chart(document.getElementById('opportunitiesClientTypeChart'), {
                type: 'pie',
                data: { labels: Object.keys(clientTypeCounts), datasets: [{ data: Object.values(clientTypeCounts), backgroundColor: chartColors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            const weightedPipelineValue = state.opportunities.reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0) * (opp.predictedWinRate / 100), 0);
            document.getElementById('weightedPipelineValue').textContent = `$${weightedPipelineValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            const avgOpportunityValue = state.opportunities.length > 0 ? state.opportunities.reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0), 0) / state.opportunities.length : 0;
            document.getElementById('avgOpportunityValue').textContent = `$${avgOpportunityValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        };

        const renderForecastView = () => {
            dom.contentArea.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Sales Forecast for ${state.currentUser}</h2>
                <p class="text-slate-600 mb-6">This forecast projects potential sales based on your current pipeline and simulated historical win rates.</p>
                <div class="w-full lg:h-96 md:h-80 h-64"><canvas id="forecastChart"></canvas></div>
            </div>`;
            const weightedPipelineValue = state.opportunities.reduce((sum, opp) => sum + (parseInt(opp.estimatedValue) || 0) * (opp.predictedWinRate / 100), 0);
            const nextMonthForecast = weightedPipelineValue * 0.4 + (Math.random() * 10000);
            const q1Forecast = weightedPipelineValue * 0.7 + (Math.random() * 20000);
            const q2Forecast = weightedPipelineValue * 0.9 + (Math.random() * 30000);
            new Chart(document.getElementById('forecastChart'), {
                type: 'bar',
                data: {
                    labels: ['Next Month', 'Current Quarter (Accum.)', 'Next Quarter (Accum.)'],
                    datasets: [{
                        label: 'Projected Sales ($)',
                        data: [nextMonthForecast, q1Forecast, q2Forecast],
                        backgroundColor: ['rgba(59, 130, 246, 0.5)', 'rgba(14, 165, 233, 0.5)', 'rgba(6, 182, 212, 0.5)'],
                        borderColor: ['rgb(59, 130, 246)', 'rgb(14, 165, 233)', 'rgb(6, 182, 212)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => '$' + value.toLocaleString() } } },
                    plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: $${context.parsed.y.toLocaleString(undefined, { maximumFractionDigits: 0 })}` } } }
                }
            });
        };

        const openClientModal = (opportunity = null) => {
            const isEdit = !!opportunity;
            const stageOptions = ['Lead', 'Prospect', 'Qualified', 'Proposal', 'Negotiation', 'Won', 'Lost'];
            const typeOptions = ['New Business', 'Existing Customer', 'Upsell', 'Cross-sell'];
            const productOptions = state.pitneyProducts;
            const clientTypeOptions = ['New', 'Organic', 'Competitive'];
            const partnerClients = state.partnerData[state.currentUser] || [];

            const modalHTML = `
            <div id="addClientModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-auto p-8 relative">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">${isEdit ? 'Edit' : 'Add New'} Client Opportunity</h2>
                    <button class="absolute top-4 right-4 text-slate-400 hover:text-slate-600" onclick="closeModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    <form id="clientForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${partnerClients.length > 0 ? `<div>
                                <label for="companyPartnerSelect" class="block text-sm font-medium text-slate-700">Select Partner Client</label>
                                <select id="companyPartnerSelect" class="partner-select mt-1 block w-full pl-3 pr-10 py-2 border border-slate-300 rounded-md shadow-sm bg-white">
                                    <option value="">-- Choose from partner list --</option>
                                    ${partnerClients.map(client => `<option value="${client}">${client}</option>`).join('')}
                                </select>
                            </div>` : ''}
                            <div ${partnerClients.length > 0 ? '' : 'class="md:col-span-2"'}>
                                <label for="companyName" class="block text-sm font-medium text-slate-700">Company Name</label>
                                <input type="text" id="companyName" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3" value="${opportunity?.companyName || ''}" required>
                            </div>
                            <div>
                                <label for="estimatedValue" class="block text-sm font-medium text-slate-700">Estimated Value ($)</label>
                                <input type="number" id="estimatedValue" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3" value="${opportunity?.estimatedValue || ''}" required>
                            </div>
                            <div class="relative">
                                <label for="totalMonthlyShippingSpend" class="block text-sm font-medium text-slate-700">Monthly Shipping Spend ($)</label>
                                <input type="number" id="totalMonthlyShippingSpend" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3" value="${opportunity?.totalMonthlyShippingSpend || ''}">
                                <span id="monthlyRoi" class="absolute right-3 top-0 mt-[34px] text-sm text-green-600 font-semibold"></span>
                            </div>
                            <div>
                                <label for="currentEquipment" class="block text-sm font-medium text-slate-700">Current Equipment</label>
                                <input type="text" id="currentEquipment" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3" value="${opportunity?.currentEquipment || ''}">
                            </div>
                            <div>
                                <label for="clientType" class="block text-sm font-medium text-slate-700">Client Type</label>
                                <select id="clientType" class="client-type-select mt-1 block w-full pl-3 pr-10 py-2 border border-slate-300 rounded-md shadow-sm bg-white" required>
                                    ${clientTypeOptions.map(ct => `<option value="${ct}" ${opportunity?.clientType === ct ? 'selected' : ''}>${ct}</option>`).join('')}
                                </select>
                            </div>
                            <div id="currentProductContainer" class="hidden">
                                <label for="currentProduct" class="block text-sm font-medium text-slate-700">Current Product</label>
                                <input type="text" id="currentProduct" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3" value="${opportunity?.currentProduct || ''}">
                            </div>
                            <div id="competitiveProductContainer" class="hidden">
                                <label for="competitiveProduct" class="block text-sm font-medium text-slate-700">Competitive Product</label>
                                <input type="text" id="competitiveProduct" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3" value="${opportunity?.competitiveProduct || ''}">
                            </div>
                            <div>
                                <label for="stage" class="block text-sm font-medium text-slate-700">Stage</label>
                                <select id="stage" class="stage-select mt-1 block w-full pl-3 pr-10 py-2 border border-slate-300 rounded-md shadow-sm bg-white" required>
                                    ${stageOptions.map(s => `<option value="${s}" ${opportunity?.stage === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="type" class="block text-sm font-medium text-slate-700">Opportunity Type</label>
                                <select id="type" class="type-select mt-1 block w-full pl-3 pr-10 py-2 border border-slate-300 rounded-md shadow-sm bg-white" required>
                                    ${typeOptions.map(t => `<option value="${t}" ${opportunity?.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="recommendedProduct" class="block text-sm font-medium text-slate-700">Recommended Product</label>
                                <select id="recommendedProduct" class="type-select mt-1 block w-full pl-3 pr-10 py-2 border border-slate-300 rounded-md shadow-sm bg-white" required>
                                    ${productOptions.map(p => `<option value="${p}" ${opportunity?.recommendedProduct === p ? 'selected' : ''}>${p}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="border border-purple-200 rounded-lg p-5 bg-purple-50/50">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">AI Analysis <span id="aiStatus" class="ml-2 text-sm text-slate-500"></span></h3>
                            <div id="aiAnalysisResult" class="bg-slate-100 p-4 rounded-md text-slate-700 prose prose-sm max-w-none">
                                ${isEdit && opportunity.companyIntel !== state.defaultAnalysis.companyIntel ? `
                                    <p><strong>Opportunity Score:</strong> ${opportunity.opportunityScore}%</p>
                                    <p><strong>Predicted Win Rate:</strong> ${opportunity.predictedWinRate}%</p>
                                    <p><strong>Next Best Action:</strong> ${opportunity.nextBestAction}</p>
                                    <p class="whitespace-pre-wrap"><strong>Auto-Generated Email:</strong>\n${opportunity.autoGeneratedEmail.body}</p>
                                ` : `<p class="italic text-slate-500">AI analysis will appear here after generating.</p>`}
                            </div>
                            <button type="button" id="generateAiBtn" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                                <div id="aiSpinner" class="spinner mr-2 hidden border-purple-300 border-l-white"></div>
                                Generate AI Analysis
                            </button>
                        </div>
                        <div class="flex justify-end pt-6 border-t border-slate-200 mt-6">
                            <button type="button" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg mr-2" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                                <div id="saveSpinner" class="spinner mr-2 hidden border-sky-300 border-l-white"></div>
                                ${isEdit ? 'Update' : 'Add'} Opportunity
                            </button>
                        </div>
                    </form>
                </div>
            </div>`;
            openModal(modalHTML, () => {
                const form = document.getElementById('clientForm');
                const companyPartnerSelect = document.getElementById('companyPartnerSelect');
                const companyNameInput = document.getElementById('companyName');
                const totalMonthlyShippingSpendInput = document.getElementById('totalMonthlyShippingSpend');
                const monthlyRoiDisplay = document.getElementById('monthlyRoi');
                const clientTypeSelect = document.getElementById('clientType');
                const currentProductContainer = document.getElementById('currentProductContainer');
                const competitiveProductContainer = document.getElementById('competitiveProductContainer');

                const calculateROI = () => {
                    const spend = parseFloat(totalMonthlyShippingSpendInput.value);
                    monthlyRoiDisplay.textContent = (!isNaN(spend) && spend > 0) ? `Est. ROI: $${(spend * 0.25).toLocaleString(undefined, { maximumFractionDigits: 0 })}` : '';
                };
                totalMonthlyShippingSpendInput.addEventListener('input', calculateROI);
                calculateROI();

                const updateProductFieldsVisibility = () => {
                    const type = clientTypeSelect.value;
                    currentProductContainer.classList.toggle('hidden', type !== 'Organic');
                    document.getElementById('currentProduct').required = type === 'Organic';
                    competitiveProductContainer.classList.toggle('hidden', type !== 'Competitive');
                    document.getElementById('competitiveProduct').required = type === 'Competitive';
                };
                clientTypeSelect.addEventListener('change', updateProductFieldsVisibility);
                updateProductFieldsVisibility();

                if (companyPartnerSelect) {
                    companyPartnerSelect.addEventListener('change', (e) => companyNameInput.value = e.target.value);
                    if (isEdit && partnerClients.includes(opportunity.companyName)) {
                        companyPartnerSelect.value = opportunity.companyName;
                    }
                }

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    document.getElementById('saveSpinner').classList.remove('hidden');
                    const newOpportunityData = {
                        id: opportunity?.id || generateUniqueId(),
                        companyName: companyNameInput.value.trim(),
                        estimatedValue: form.elements.estimatedValue.value,
                        stage: form.elements.stage.value,
                        type: form.elements.type.value,
                        recommendedProduct: form.elements.recommendedProduct.value,
                        totalMonthlyShippingSpend: totalMonthlyShippingSpendInput.value,
                        currentEquipment: form.elements.currentEquipment.value,
                        clientType: clientTypeSelect.value,
                        currentProduct: clientTypeSelect.value === 'Organic' ? form.elements.currentProduct.value : '',
                        competitiveProduct: clientTypeSelect.value === 'Competitive' ? form.elements.competitiveProduct.value : '',
                    };
                    const finalOpportunity = { ...state.defaultAnalysis, ...opportunity, ...newOpportunityData };
                    
                    if (isEdit) {
                        state.opportunities = state.opportunities.map(opp => opp.id === finalOpportunity.id ? finalOpportunity : opp);
                    } else {
                        state.opportunities.push(finalOpportunity);
                    }
                    saveState();
                    renderOpportunities();
                    renderNextBestAction();
                    renderPipelineSummary();
                    closeModal();
                });

                document.getElementById('generateAiBtn').addEventListener('click', async () => {
                    const companyName = companyNameInput.value.trim();
                    if (!companyName) {
                        openModal(`<div class="modal ..."><p>Please fill in Company Name first.</p>...</div>`);
                        return;
                    }

                    const aiSpinner = document.getElementById('aiSpinner');
                    aiSpinner.classList.remove('hidden');
                    document.getElementById('generateAiBtn').disabled = true;
                    document.getElementById('aiStatus').textContent = '(Generating...)';

                    try {
                        const aiAnalysis = await generateAIOpportunityAnalysis(
                            companyName, form.elements.estimatedValue.value, form.elements.stage.value, form.elements.type.value,
                            totalMonthlyShippingSpendInput.value, form.elements.currentEquipment.value, form.elements.currentProduct.value,
                            form.elements.competitiveProduct.value, clientTypeSelect.value
                        );
                        openClientModal({ ...state.defaultAnalysis, ...opportunity, ...Object.fromEntries(new FormData(form)), ...aiAnalysis });
                    } catch (error) {
                        console.error("AI analysis failed:", error);
                        document.getElementById('aiAnalysisResult').innerHTML = `<p class="text-red-500">Failed to generate: ${error.message}.</p>`;
                        document.getElementById('aiStatus').textContent = '(Failed!)';
                    } finally {
                        aiSpinner.classList.add('hidden');
                        document.getElementById('generateAiBtn').disabled = false;
                    }
                });
            });
        };
        
        // MODIFIED: Calls the secure backend function
        const generateAIOpportunityAnalysis = async (companyName, estimatedValue, stage, type, totalMonthlyShippingSpend, currentEquipment, currentProduct, competitiveProduct, clientType) => {
            const productsList = state.pitneyProducts.join(', ');
            let promptText = `Analyze a sales opportunity for ${companyName} (Estimated Value: $${estimatedValue}, Stage: ${stage}, Type: ${type}, Client Type: ${clientType}). Client has monthly shipping spend of $${totalMonthlyShippingSpend} and uses this equipment: "${currentEquipment}".`;
            if (currentProduct && clientType === 'Organic') promptText += ` They currently use Pitney Bowes product: "${currentProduct}".`;
            if (competitiveProduct && clientType === 'Competitive') promptText += ` They currently use a competitive product: "${competitiveProduct}".`;
            promptText += `\nProvide analysis in JSON format with fields: opportunityScore (number), predictedWinRate (number), recommendedProduct (string from [${productsList}]), companyIntel (string), strategicSummary (string), nextBestAction (string), potentialRisks (array of strings), personalizedValueProposition (string), and autoGeneratedEmail (object with 'subject' and 'body'). Output ONLY the JSON object.`;

            const response = await fetch('/.netlify/functions/generateWithGemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: promptText }),
            });

            if (!response.ok) throw new Error(`AI analysis failed: ${await response.text()}`);
            const data = await response.json();
            if (data.promptFeedback?.blockReason) throw new Error(`Prompt blocked by safety filters: ${data.promptFeedback.blockReason}.`);
            const textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!textContent) throw new Error("No content received from AI.");

            const analysisResult = JSON.parse(textContent.trim());

            return {
                opportunityScore: Math.max(0, Math.min(100, parseInt(analysisResult.opportunityScore) || 0)),
                predictedWinRate: Math.max(0, Math.min(100, parseInt(analysisResult.predictedWinRate) || 0)),
                recommendedProduct: state.pitneyProducts.includes(analysisResult.recommendedProduct) ? analysisResult.recommendedProduct : state.pitneyProducts[0],
                companyIntel: analysisResult.companyIntel || "N/A",
                strategicSummary: analysisResult.strategicSummary || "N/A",
                nextBestAction: analysisResult.nextBestAction || "N/A",
                potentialRisks: Array.isArray(analysisResult.potentialRisks) ? analysisResult.potentialRisks : [],
                personalizedValueProposition: analysisResult.personalizedValueProposition || "N/A",
                autoGeneratedEmail: {
                    subject: analysisResult.autoGeneratedEmail?.subject || "Follow-up",
                    body: analysisResult.autoGeneratedEmail?.body || `Dear [Contact Name],\n\nFollowing up on our conversation...\n\nBest,\n${state.currentUser}`
                }
            };
        };

        const exportToCsv = () => {
            if (state.opportunities.length === 0) {
                openModal(`<div class="..."><p>No opportunities to export!</p>...</div>`);
                return;
            }
            const headers = ["Company Name", "Estimated Value", "Stage", "Type", "Recommended Product", "Opp. Score", "Win Rate", "Next Best Action"];
            const rows = state.opportunities.map(opp => [
                `"${opp.companyName.replace(/"/g, '""')}"`, opp.estimatedValue, opp.stage, opp.type, opp.recommendedProduct, opp.opportunityScore, opp.predictedWinRate, `"${(opp.nextBestAction || '').replace(/"/g, '""')}"`
            ].join(","));
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `Veridian_Pipeline_${state.currentUser}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        init();
    });
    </script>
</body>
</html>